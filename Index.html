<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Claude Bridge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2d2d2d;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            flex-shrink: 0;
        }

        .header h1 {
            color: #00d4aa;
            font-size: 1.1rem;
            margin: 0;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .api-key-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .api-key-section.hidden {
            display: none;
        }

        .api-key-section input {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 0.4rem;
            color: #e0e0e0;
            width: 180px;
            font-size: 0.8rem;
        }

        .api-key-section button, .api-dropdown button {
            background: #00d4aa;
            color: #1a1a1a;
            border: none;
            border-radius: 4px;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .api-key-section button:hover, .api-dropdown button:hover {
            background: #00b894;
        }

        .api-key-section button.clear-btn {
            background: #c0392b;
            color: white;
        }

        .api-key-section button.clear-btn:hover {
            background: #a93226;
        }

        .api-dropdown {
            position: relative;
        }

        .api-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 0.5rem;
            z-index: 1000;
            min-width: 200px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .api-dropdown-content.show {
            display: block;
        }

        .api-dropdown-content input {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 0.4rem;
            color: #e0e0e0;
            width: 100%;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }

        .api-dropdown-content .button-group {
            display: flex;
            gap: 0.5rem;
        }

        .status {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .status-item {
            padding: 0.3rem 0.6rem;
            background: #333;
            border-radius: 3px;
            font-size: 0.75rem;
        }

        .status-item.connected {
            background: #0a7c42;
        }

        .claude-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
        }

        .claude-status.connected {
            color: #27ae60;
        }

        .claude-status.disconnected {
            color: #e74c3c;
        }

        .claude-status button {
            background: #444;
            color: #e0e0e0;
            border: none;
            border-radius: 4px;
            padding: 0.3rem 0.6rem;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .claude-status button:hover {
            background: #555;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .chat-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #444;
        }

        .arduino-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #252525;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #1e1e1e;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            max-width: 90%;
        }

        .message.user {
            background: #0056b3;
            margin-left: auto;
        }

        .message.claude {
            background: #2d2d2d;
        }

        .code-block {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 1rem;
            margin: 0.5rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .chat-input {
            padding: 1rem;
            background: #2d2d2d;
            border-top: 1px solid #444;
            display: flex;
            gap: 0.5rem;
        }

        .chat-input textarea {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 0.75rem;
            color: #e0e0e0;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .chat-input button {
            background: #00d4aa;
            color: #1a1a1a;
            border: none;
            border-radius: 4px;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: bold;
        }

        .chat-input button:hover {
            background: #00b894;
        }

        .arduino-controls {
            padding: 0.75rem;
            border-bottom: 1px solid #444;
        }

        .control-group {
            margin-bottom: 0.75rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: bold;
            color: #00d4aa;
            font-size: 0.85rem;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 0.4rem;
            color: #e0e0e0;
            font-size: 0.85rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .action-buttons button {
            flex: 1;
            background: #444;
            color: #e0e0e0;
            border: none;
            border-radius: 4px;
            padding: 0.6rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .action-buttons button:hover {
            background: #555;
        }

        .action-buttons button.compile {
            background: #e67e22;
        }

        .action-buttons button.upload {
            background: #27ae60;
        }

        .action-buttons button:disabled {
            background: #333;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .serial-monitor {
            flex: 1;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
        }

        .serial-output {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 0.75rem;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            overflow-y: auto;
            white-space: pre-wrap;
            color: #0fa;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #444;
            border-radius: 50%;
            border-top-color: #00d4aa;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            color: #e74c3c;
        }

        .success {
            color: #27ae60;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ Arduino Claude Bridge</h1>
        <div class="header-controls">
            <!-- Show API key input only when not connected -->
            <div class="api-key-section" id="api-key-section">
                <input type="password" id="api-key-input" placeholder="Enter Claude API key..." />
                <button type="button" id="connect-btn">Connect</button>
            </div>
            
            <!-- Show compact status when connected -->
            <div class="claude-status disconnected" id="claude-status">
                <span>‚ö†Ô∏è Enter API Key</span>
            </div>
            
            <!-- Dropdown for connected state -->
            <div class="api-dropdown" id="api-dropdown" style="display: none;">
                <button type="button" id="api-settings-btn">‚öôÔ∏è API</button>
                <div class="api-dropdown-content" id="api-dropdown-content">
                    <input type="password" id="api-key-update" placeholder="Enter new API key..." />
                    <div class="button-group">
                        <button type="button" id="update-btn">Update</button>
                        <button type="button" id="clear-btn" class="clear-btn">Clear</button>
                    </div>
                </div>
            </div>
            
            <div class="status">
                <div class="status-item" id="arduino-status">CLI: Checking...</div>
                <div class="status-item" id="board-status">No Board</div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="chat-section">
            <div class="chat-messages" id="chat-messages">
                <div class="message claude">
                    <strong>Claude:</strong> Hi! I'm your Arduino development assistant. <span id="welcome-message">Enter your API key above to get started, then ask me to write code for your projects!</span>
                </div>
            </div>
            
            <div class="chat-input">
                <textarea id="user-input" placeholder="Ask Claude to write Arduino code..."></textarea>
                <button type="button" id="send-btn">Send</button>
            </div>
        </div>

        <div class="arduino-section">
            <div class="arduino-controls">
                <div class="control-group">
                    <label for="sketch-load">Load Sketch:</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="sketch-load" style="flex: 1;">
                            <option value="">Select sketch...</option>
                        </select>
                        <button type="button" id="refresh-sketches-btn" style="padding: 0.4rem 0.8rem; background: #444; color: #e0e0e0; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">‚Üª</button>
                    </div>
                </div>

                <div class="control-group">
                    <label for="sketch-name">Sketch Name:</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="sketch-name" value="my_sketch" placeholder="Enter sketch name" style="flex: 1;" />
                        <button type="button" id="save-sketch-btn" style="padding: 0.4rem 0.8rem; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Save</button>
                    </div>
                    <div id="current-sketch-info" style="font-size: 0.75rem; color: #888; margin-top: 0.25rem;">No sketch loaded</div>
                </div>

                <div class="control-group">
                    <label for="board-select">Board:</label>
                    <select id="board-select">
                        <option value="">Loading boards...</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="port-select">Port:</label>
                    <select id="port-select">
                        <option value="">Select Port...</option>
                    </select>
                    <button type="button" id="refresh-ports-btn" style="margin-top: 0.5rem; width: 100%; padding: 0.4rem; background: #444; color: #e0e0e0; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Refresh Ports</button>
                </div>

                <div class="action-buttons">
                    <button type="button" class="compile" id="compile-btn">Compile</button>
                    <button type="button" class="upload" id="upload-btn">Upload</button>
                </div>
            </div>

            <div class="serial-monitor">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <label style="color: #00d4aa; font-weight: bold; font-size: 0.85rem;">Serial Monitor</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <label style="font-size: 0.75rem; color: #ccc;">Baud:</label>
                        <select id="baud-select" style="background: #1a1a1a; border: 1px solid #444; border-radius: 3px; padding: 0.25rem; color: #e0e0e0; font-size: 0.75rem;">
                            <option value="9600">9600</option>
                            <option value="19200">19200</option>
                            <option value="38400">38400</option>
                            <option value="57600">57600</option>
                            <option value="115200">115200</option>
                        </select>
                    </div>
                </div>
                <div class="serial-output" id="serial-output">Waiting for serial data...</div>
                <button type="button" id="read-serial-btn" style="margin-top: 0.5rem; padding: 0.4rem; font-size: 0.85rem;">Read Serial</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentCode = '';
        let currentSketchName = '';
        let claudeApiKey = '';

        // API Key Management Functions
        function setApiKey() {
            const apiKeyInput = document.getElementById('api-key-input');
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                alert('Please enter your Claude API key');
                return;
            }

            if (!apiKey.startsWith('sk-ant-')) {
                alert('Claude API keys should start with "sk-ant-"');
                return;
            }

            saveApiKey(apiKey);
            apiKeyInput.value = '';
            showConnectedState();
            
            addMessage('claude', 'API key connected and saved! I\'m ready to help you with Arduino development. What would you like to build?');
        }

        function updateApiKey() {
            const apiKeyInput = document.getElementById('api-key-update');
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                alert('Please enter your Claude API key');
                return;
            }

            if (!apiKey.startsWith('sk-ant-')) {
                alert('Claude API keys should start with "sk-ant-"');
                return;
            }

            saveApiKey(apiKey);
            apiKeyInput.value = '';
            document.getElementById('api-dropdown-content').classList.remove('show');
            
            addMessage('claude', 'API key updated successfully!');
        }

        function saveApiKey(apiKey) {
            try {
                localStorage.setItem('claude-api-key', apiKey);
                claudeApiKey = apiKey;
                console.log('API key saved to localStorage');
            } catch (error) {
                console.error('Error saving API key:', error);
                alert('Warning: Could not save API key for future sessions');
            }
        }

        function clearApiKey() {
            if (!confirm('Are you sure you want to clear your saved API key?')) {
                return;
            }

            try {
                localStorage.removeItem('claude-api-key');
                console.log('API key removed from localStorage');
            } catch (error) {
                console.error('Error clearing API key:', error);
            }

            claudeApiKey = '';
            document.getElementById('api-key-input').value = '';
            document.getElementById('api-key-update').value = '';
            document.getElementById('api-dropdown-content').classList.remove('show');
            
            showDisconnectedState();
            addMessage('claude', 'API key cleared. Please enter a new key to continue using Claude assistance.');
        }

        function toggleApiDropdown() {
            const dropdown = document.getElementById('api-dropdown-content');
            dropdown.classList.toggle('show');
        }

        // UI State Management
        function loadSavedApiKey() {
            try {
                const savedKey = localStorage.getItem('claude-api-key');
                if (savedKey && savedKey.startsWith('sk-ant-')) {
                    claudeApiKey = savedKey;
                    showConnectedState();
                    
                    const welcomeMsg = document.getElementById('welcome-message');
                    if (welcomeMsg) {
                        welcomeMsg.textContent = 'I\'m connected and ready! What Arduino project would you like to work on?';
                    }
                    
                    console.log('Loaded saved Claude API key');
                } else {
                    showDisconnectedState();
                    console.log('No saved API key found');
                }
            } catch (error) {
                console.error('Error loading saved API key:', error);
                showDisconnectedState();
            }
        }

        function loadSavedBoardAndPort() {
            try {
                const savedBoard = localStorage.getItem('selected-board');
                const savedPort = localStorage.getItem('selected-port');
                
                if (savedBoard) {
                    const boardSelect = document.getElementById('board-select');
                    // Set the value after boards are loaded
                    setTimeout(() => {
                        if (Array.from(boardSelect.options).some(option => option.value === savedBoard)) {
                            boardSelect.value = savedBoard;
                            console.log('Loaded saved board:', savedBoard);
                        }
                    }, 1000);
                }
                
                if (savedPort) {
                    const portSelect = document.getElementById('port-select');
                    // Set the value after ports are loaded
                    setTimeout(() => {
                        if (Array.from(portSelect.options).some(option => option.value === savedPort)) {
                            portSelect.value = savedPort;
                            console.log('Loaded saved port:', savedPort);
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('Error loading saved board/port:', error);
            }
        }

        function saveBoardSelection(board) {
            try {
                if (board) {
                    localStorage.setItem('selected-board', board);
                    console.log('Saved board selection:', board);
                } else {
                    localStorage.removeItem('selected-board');
                }
            } catch (error) {
                console.error('Error saving board selection:', error);
            }
        }

        function savePortSelection(port) {
            try {
                if (port) {
                    localStorage.setItem('selected-port', port);
                    console.log('Saved port selection:', port);
                } else {
                    localStorage.removeItem('selected-port');
                }
            } catch (error) {
                console.error('Error saving port selection:', error);
            }
        }

        function showConnectedState() {
            document.getElementById('api-key-section').style.display = 'none';
            document.getElementById('claude-status').className = 'claude-status connected';
            document.getElementById('claude-status').innerHTML = '<span>‚úÖ Claude Connected</span>';
            document.getElementById('api-dropdown').style.display = 'block';
        }

        function showDisconnectedState() {
            document.getElementById('api-key-section').style.display = 'flex';
            document.getElementById('claude-status').className = 'claude-status disconnected';
            document.getElementById('claude-status').innerHTML = '<span>‚ö†Ô∏è Enter API Key</span>';
            document.getElementById('api-dropdown').style.display = 'none';
        }

        // Sketch Management Functions
        async function refreshSketches() {
            try {
                const response = await fetch('/api/sketches');
                const data = await response.json();
                
                const sketchSelect = document.getElementById('sketch-load');
                sketchSelect.innerHTML = '<option value="">Select sketch...</option>';
                
                if (data.success && data.sketches) {
                    data.sketches.forEach(sketch => {
                        const option = document.createElement('option');
                        option.value = sketch.name;
                        const date = new Date(sketch.modified).toLocaleDateString();
                        const source = sketch.source === 'sketchbook' ? 'üìÅ' : 'üíæ';  
                        option.textContent = `${source} ${sketch.name} (${date})`;
                        sketchSelect.appendChild(option);
                    });
                    
                    console.log(`Found ${data.sketches.length} sketches`);
                }
            } catch (error) {
                console.error('Error loading sketches:', error);
            }
        }

        async function loadSketch(sketchName) {
            try {
                const response = await fetch(`/api/sketches/${sketchName}`);
                const data = await response.json();
                
                if (data.success) {
                    currentCode = data.content;
                    currentSketchName = data.name;
                    
                    document.getElementById('sketch-name').value = sketchName;
                    document.getElementById('current-sketch-info').textContent = `Loaded: ${sketchName}`;
                    
                    addMessage('claude', `üìÇ Loaded sketch "${sketchName}"`, false);
                    addMessage('claude', data.content, true);
                    
                    console.log(`Loaded sketch: ${sketchName}`);
                } else {
                    alert(`Failed to load sketch: ${data.error}`);
                }
            } catch (error) {
                console.error('Error loading sketch:', error);
                alert('Error loading sketch');
            }
        }

        async function saveCurrentSketch() {
            const sketchName = document.getElementById('sketch-name').value.trim();
            
            if (!sketchName) {
                alert('Please enter a sketch name');
                return;
            }

            if (!currentCode) {
                alert('No code to save. Ask Claude to generate some Arduino code first!');
                return;
            }

            try {
                const response = await fetch('/api/sketch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: currentCode,
                        name: sketchName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentSketchName = sketchName;
                    document.getElementById('current-sketch-info').textContent = `Saved: ${sketchName}`;
                    addMessage('claude', `üíæ Sketch saved as "${sketchName}"`, false);
                    
                    refreshSketches();
                } else {
                    alert(`Failed to save sketch: ${result.error}`);
                }
            } catch (error) {
                console.error('Error saving sketch:', error);
                alert('Error saving sketch');
            }
        }

        // Arduino Integration Functions  
        async function checkArduinoStatus() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                const statusElement = document.getElementById('arduino-status');
                if (data.arduino_cli) {
                    statusElement.textContent = 'CLI: Ready';
                    statusElement.classList.add('connected');
                } else {
                    statusElement.textContent = 'CLI: Missing';
                    statusElement.classList.remove('connected');
                }
            } catch (error) {
                document.getElementById('arduino-status').textContent = 'CLI: Error';
            }
        }

        async function loadArduinoConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                
                if (data.success && data.sketchbookPath && data.sketchbookPath !== 'Not found') {
                    console.log('Arduino sketchbook folder:', data.sketchbookPath);
                }
            } catch (error) {
                console.error('Error loading Arduino config:', error);
            }
        }

        async function loadAvailableBoards() {
            try {
                const response = await fetch('/api/boards/available');
                const data = await response.json();
                
                const boardSelect = document.getElementById('board-select');
                const savedBoard = localStorage.getItem('selected-board');
                boardSelect.innerHTML = '<option value="">Select Board...</option>';
                
                if (data.success && data.stdout) {
                    const lines = data.stdout.split('\n');
                    const boards = [];
                    
                    lines.forEach(line => {
                        const match = line.match(/^(.+?)\s+([a-zA-Z0-9_]+:[a-zA-Z0-9_]+:[a-zA-Z0-9_]+.*?)$/);
                        if (match) {
                            const [, name, fqbn] = match;
                            boards.push({ name: name.trim(), fqbn: fqbn.trim() });
                        }
                    });
                    
                    boards.sort((a, b) => a.name.localeCompare(b.name));
                    
                    boards.forEach(board => {
                        const option = document.createElement('option');
                        option.value = board.fqbn;
                        option.textContent = board.name;
                        boardSelect.appendChild(option);
                    });
                    
                    // Restore saved board selection if it exists in the list
                    if (savedBoard && Array.from(boardSelect.options).some(option => option.value === savedBoard)) {
                        boardSelect.value = savedBoard;
                    }
                    
                    console.log(`Loaded ${boards.length} boards from your Arduino installation`);
                } else {
                    const fallbackBoards = [
                        { name: 'ESP32 Dev Module', fqbn: 'esp32:esp32:esp32' },
                        { name: 'ESP32-S3', fqbn: 'esp32:esp32:esp32s3' },
                        { name: 'ESP32-C3', fqbn: 'esp32:esp32:esp32c3' },
                        { name: 'Arduino Uno', fqbn: 'arduino:avr:uno' },
                        { name: 'Arduino Nano', fqbn: 'arduino:avr:nano' },
                        { name: 'Arduino Mega', fqbn: 'arduino:avr:mega' },
                        { name: 'Teensy 4.0', fqbn: 'teensy:avr:teensy40' },
                        { name: 'Teensy 4.1', fqbn: 'teensy:avr:teensy41' }
                    ];
                    
                    fallbackBoards.forEach(board => {
                        const option = document.createElement('option');
                        option.value = board.fqbn;
                        option.textContent = board.name;
                        boardSelect.appendChild(option);
                    });
                    
                    // Restore saved board selection if it exists in the fallback list
                    if (savedBoard && Array.from(boardSelect.options).some(option => option.value === savedBoard)) {
                        boardSelect.value = savedBoard;
                    }
                    
                    console.log('Using fallback board list (install cores with Arduino CLI for more options)');
                }
            } catch (error) {
                console.error('Error loading available boards:', error);
            }
        }

        async function refreshPorts() {
            try {
                const response = await fetch('/api/boards');
                const data = await response.json();
                
                const portSelect = document.getElementById('port-select');
                const savedPort = localStorage.getItem('selected-port');
                portSelect.innerHTML = '<option value="">Select Port...</option>';
                
                if (data.success && data.stdout) {
                    const lines = data.stdout.split('\n');
                    lines.forEach(line => {
                        if (line.includes('COM') || line.includes('/dev/')) {
                            const parts = line.split(/\s+/);
                            const port = parts[0];
                            if (port) {
                                const option = document.createElement('option');
                                option.value = port;
                                option.textContent = line.trim();
                                portSelect.appendChild(option);
                            }
                        }
                    });
                    
                    // Restore saved port selection if it exists in the list
                    if (savedPort && Array.from(portSelect.options).some(option => option.value === savedPort)) {
                        portSelect.value = savedPort;
                    }
                }
            } catch (error) {
                console.error('Error refreshing ports:', error);
            }
        }

        // Message and Chat Functions
        function addMessage(sender, content, isCode = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (isCode) {
                messageDiv.innerHTML = `<strong>${sender === 'user' ? 'You' : 'Claude'}:</strong><div class="code-block">${content}</div>`;
                if (sender === 'claude') {
                    currentCode = content;
                }
            } else {
                messageDiv.innerHTML = `<strong>${sender === 'user' ? 'You' : 'Claude'}:</strong> ${content}`;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!claudeApiKey) {
                alert('Please set your Claude API key first');
                return;
            }
            
            addMessage('user', message);
            input.value = '';
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message claude';
            loadingDiv.innerHTML = '<strong>Claude:</strong> <span class="loading"></span> Thinking...';
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                let systemPrompt = `You are an Arduino development assistant. Help users write, debug, and improve Arduino code. When you provide Arduino code, make sure it's complete and ready to compile. Focus on practical, working solutions for embedded development.

Key guidelines:
- Provide complete, compilable Arduino sketches
- Include necessary #include statements and library dependencies
- Use clear variable names and add helpful comments
- Suggest appropriate pin numbers and configurations
- Mention any required libraries or board configurations
- For ESP32, Teensy, and other advanced boards, use their specific features when beneficial`;

                if (currentCode && currentSketchName) {
                    systemPrompt += `

CURRENT PROJECT CONTEXT:
The user is currently working on a sketch called "${currentSketchName}". Here is the current code:

\`\`\`cpp
${currentCode}
\`\`\`

When the user asks questions or requests modifications, consider this existing code as context. You can:
- Suggest improvements to the existing code
- Help debug issues in the current sketch
- Add new features to the existing project
- Explain how the current code works
- Optimize or refactor the existing code

If the user asks for completely new code, you can still reference patterns or approaches from their current project.`;
                }

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': claudeApiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4000,
                        system: systemPrompt,
                        messages: [
                            {
                                role: 'user',
                                content: message
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                loadingDiv.remove();
                
                if (data.content && data.content[0] && data.content[0].text) {
                    const claudeResponse = data.content[0].text;
                    
                    const codeMatch = claudeResponse.match(/```(?:cpp|arduino|c\+\+)?\n([\s\S]*?)\n```/);
                    
                    if (codeMatch) {
                        const code = codeMatch[1];
                        const textPart = claudeResponse.replace(codeMatch[0], '').trim();
                        
                        if (textPart) {
                            addMessage('claude', textPart);
                        }
                        addMessage('claude', code, true);
                    } else {
                        addMessage('claude', claudeResponse);
                    }
                } else {
                    addMessage('claude', 'Sorry, I received an unexpected response from the API.');
                }
                
            } catch (error) {
                loadingDiv.remove();
                console.error('Claude API error:', error);
                
                let errorMessage = 'Sorry, there was an error connecting to Claude. ';
                if (error.message.includes('401')) {
                    errorMessage += 'Please check your API key is correct.';
                } else if (error.message.includes('429')) {
                    errorMessage += 'Rate limit exceeded. Please wait a moment and try again.';
                } else {
                    errorMessage += 'Please check your internet connection and API key.';
                }
                
                addMessage('claude', errorMessage);
            }
        }

        // Arduino Compile and Upload Functions
        async function compileSketch() {
            const board = document.getElementById('board-select').value;
            const sketchName = document.getElementById('sketch-name').value || 'temp_sketch';
            
            if (!board) {
                alert('Please select a board');
                return;
            }
            
            if (!currentCode) {
                alert('No code to compile. Ask Claude to generate some Arduino code first!');
                return;
            }
            
            const compileBtn = document.getElementById('compile-btn');
            compileBtn.disabled = true;
            compileBtn.innerHTML = '<span class="loading"></span> Compiling...';
            
            try {
                const response = await fetch('/api/compile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        board: board,
                        code: currentCode,
                        name: sketchName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addMessage('claude', `‚úÖ Compilation successful!\n\n${result.stdout}`, false);
                } else {
                    addMessage('claude', `‚ùå Compilation failed:\n\n${result.stderr || result.error}`, false);
                }
            } catch (error) {
                addMessage('claude', `‚ùå Error during compilation: ${error.message}`, false);
            } finally {
                compileBtn.disabled = false;
                compileBtn.textContent = 'Compile';
            }
        }

        async function uploadSketch() {
            const board = document.getElementById('board-select').value;
            const port = document.getElementById('port-select').value;
            const sketchName = document.getElementById('sketch-name').value || 'temp_sketch';
            
            if (!board || !port) {
                alert('Please select both board and port');
                return;
            }
            
            if (!currentCode) {
                alert('No code to upload. Ask Claude to generate some Arduino code first!');
                return;
            }
            
            const uploadBtn = document.getElementById('upload-btn');
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="loading"></span> Uploading...';
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        board: board,
                        port: port,
                        code: currentCode,
                        name: sketchName
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addMessage('claude', `‚úÖ Upload successful!\n\n${result.stdout}`, false);
                    document.getElementById('board-status').textContent = `Connected`;
                    document.getElementById('board-status').classList.add('connected');
                } else {
                    addMessage('claude', `‚ùå Upload failed:\n\n${result.stderr || result.error}`, false);
                }
            } catch (error) {
                addMessage('claude', `‚ùå Error during upload: ${error.message}`, false);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload';
            }
        }

        // Serial Monitor Functions
        async function readSerial() {
            const port = document.getElementById('port-select').value;
            const baud = document.getElementById('baud-select').value;
            
            if (!port) {
                alert('Please select a port');
                return;
            }
            
            try {
                // Temporarily use the working direct endpoint until main one is fixed
                const response = await fetch(`/api/monitor-direct/${port}?timeout=5&baud=${baud}`);
                const result = await response.json();
                
                const serialOutput = document.getElementById('serial-output');
                if (result.success && result.stdout && result.stdout.trim()) {
                    serialOutput.textContent = result.stdout;
                    serialOutput.style.color = '#0fa'; // Green for success
                } else if (result.stderr && result.stderr.trim()) {
                    serialOutput.textContent = `Error: ${result.stderr}`;
                    serialOutput.style.color = '#e74c3c'; // Red for error
                } else {
                    serialOutput.textContent = `No data received (${baud} baud, 5s timeout) - using direct method`;
                    serialOutput.style.color = '#888'; // Gray for no data
                }
            } catch (error) {
                const serialOutput = document.getElementById('serial-output');
                serialOutput.textContent = `Error reading serial: ${error.message}`;
                serialOutput.style.color = '#e74c3c';
            }
        }

        function saveBaudSelection(baud) {
            try {
                if (baud) {
                    localStorage.setItem('selected-baud', baud);
                    console.log('Saved baud selection:', baud);
                }
            } catch (error) {
                console.error('Error saving baud selection:', error);
            }
        }

        function loadSavedBaud() {
            try {
                const savedBaud = localStorage.getItem('selected-baud') || '9600'; // Default to 9600
                const baudSelect = document.getElementById('baud-select');
                baudSelect.value = savedBaud;
                console.log('Loaded saved baud rate:', savedBaud);
            } catch (error) {
                console.error('Error loading saved baud rate:', error);
            }
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedApiKey();
            loadSavedBaud();
            checkArduinoStatus();
            loadArduinoConfig();
            loadAvailableBoards();
            refreshPorts();
            refreshSketches();
            
            // Event listeners
            document.getElementById('connect-btn').addEventListener('click', setApiKey);
            document.getElementById('api-settings-btn').addEventListener('click', toggleApiDropdown);
            document.getElementById('update-btn').addEventListener('click', updateApiKey);
            document.getElementById('clear-btn').addEventListener('click', clearApiKey);
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('refresh-sketches-btn').addEventListener('click', refreshSketches);
            document.getElementById('save-sketch-btn').addEventListener('click', saveCurrentSketch);
            document.getElementById('refresh-ports-btn').addEventListener('click', refreshPorts);
            document.getElementById('compile-btn').addEventListener('click', compileSketch);
            document.getElementById('upload-btn').addEventListener('click', uploadSketch);
            document.getElementById('read-serial-btn').addEventListener('click', readSerial);
            
            // Save board/port/baud selections when they change
            document.getElementById('board-select').addEventListener('change', function(e) {
                saveBoardSelection(e.target.value);
            });
            
            document.getElementById('port-select').addEventListener('change', function(e) {
                savePortSelection(e.target.value);
            });
            
            document.getElementById('baud-select').addEventListener('change', function(e) {
                saveBaudSelection(e.target.value);
            });
            
            // Enter key handlers
            document.getElementById('api-key-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    setApiKey();
                }
            });
            
            document.getElementById('api-key-update').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    updateApiKey();
                }
            });
            
            document.getElementById('user-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('sketch-load').addEventListener('change', function(e) {
                if (e.target.value) {
                    loadSketch(e.target.value);
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById('api-dropdown');
                const dropdownContent = document.getElementById('api-dropdown-content');
                
                if (dropdown && !dropdown.contains(event.target)) {
                    dropdownContent.classList.remove('show');
                }
            });
        });

        // Auto-refresh serial monitor every 5 seconds if a port is selected
        setInterval(() => {
            const port = document.getElementById('port-select').value;
            if (port) {
                readSerial();
            }
        }, 5000);

    </script>
</body>
</html>
